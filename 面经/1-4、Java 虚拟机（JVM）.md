

# 1-4 Java 虚拟机

## 1、Java 内存

在 Java 虚拟机的自动内存管理机制下，无需手动 delete/free 操作，不容易出现内存泄露和内存溢出问题，全权交给虚拟机管理。但一旦出现内存泄露和溢出等问题，需要了解虚拟机的内存管理机制。

### 1.1 数据区域（基于JDK 1.8）

**Java 虚拟机**在执行 Java 程序的过程中会把它管理的内存划分成若干个不同的数据区域，如下图所示。

![image-20220729151844436](https://img.zxdmy.com/2022/202207291602860.png)

下面详细讲述各个内存区域。先从线程私有区域开始：

> **线程私有内存区域** 的 **生命周期和线程相同**，随着线程的创建而创建，随着线程的死亡而死亡。

#### 虚拟机栈

`Java 虚拟机栈` ，是 JVM 运行时数据区域的一个核心，除了一些 Native 方法调用是通过**本地方法栈** 实现的，**其他所有的 Java 方法调用都是通过虚拟机栈来实现的**（也需要和其他运行时数据区域比如程序计数器配合）。

**方法调用** 的数据需要通过栈进行传递，每一次方法调用都会有一个对应的 `栈帧` 被压入栈中，每一个方法调用结束后，都会有一个 `栈帧` 被弹出。

**虚拟机栈** 由一个个`栈帧`组成，而每个栈帧中都拥有：`局部变量表`、`操作数栈`、`动态链接`、`方法返回地址`。

+ **局部变量表**：存放编译期可知的**各种数据类型**（如8种基本数据类型）、**对象引用**（如指向对象起始地址的引用指针、指向一个代表对象的句柄或其他与此对象相关的位置）。
+ **操作数栈**：作为**方法调用**的中转站使用，用于存放方法执行过程中产生的中间计算结果，以及计算过程中产生的临时变量。
+ **动态链接**：服务一个方法需要调用其他方法的场景。

> 关于**动态链接**：Java 源文件被编译成字节码文件时，所有的变量和方法引用都作为 `符号引用` 保存在 Class 文件的`常量池`里。当一个方法要调用其他方法，需要将`常量池`中指向方法的`符号引用`转化为其在内存地址中的`直接引用`。**动态链接的作用就是为了将符号引用转换为调用方法的直接引用**。![image-20220729153941829](https://img.zxdmy.com/2022/202207291539415.png)

**虚拟机栈** 和数据结构上的栈类似，也是 **先进后出** 的数据结构，只支持**出栈**和**入栈**两种操作。

![image-20220729153145253](https://img.zxdmy.com/2022/202207291531704.png)

程序运行中，**虚拟机栈** 可能会出现两种错误：

- `StackOverFlowError`： 若虚拟机栈的内存大小不允许动态扩展，那么当线程请求虚拟机栈的深度超过当前 Java 虚拟机栈的最大深度的时候，就抛出 `StackOverFlowError` 错误。
- `OutOfMemoryError`： 如果虚拟机栈的内存大小可以动态扩展， 但是虚拟机在动态扩展栈时无法申请到足够的内存空间，则抛出 `OutOfMemoryError` 异常。

#### 本地方法栈

**本地方法栈** 为虚拟机使用到的 `Native 方法` 服务。

本地方法被执行的时候，在**本地方法栈**也会创建一个`栈帧`，用于存放该本地方法的局部变量表、操作数栈、动态链接、出口信息。

方法执行完毕后相应的栈帧也会出栈并释放内存空间，也会出现 `StackOverFlowError` 和 `OutOfMemoryError` 两种错误。

>  在 `HotSpot 虚拟机` 中，**本地方法栈 和 Java 虚拟机栈 合二为一。**

#### 程序计数器

程序计数器是一块较小的内存空间，可以看作 `当前线程所执行的字节码的行号指示器`。

其作用如下：

+ `字节码解释器` 通过改变程序计数器来依次读取指令，从而实现代码的流程控制，如：顺序执行、选择、循环、异常处理。
+ 在 `多线程` 的情况下，程序计数器用于 **记录当前线程执行的位置**，从而当线程被切换回来的时候能够知道该线程上次运行到哪儿了。

> 正是为了线程切换时能恢复到正确的执行位置，所以每条线程都需要有一个独立的程序计数器，以保证各线程之间计数器互不影响，独立存储。

> 接下来是 线程共享区域：

#### 堆



#### 方法区



#### 直接内存 (非运行时数据区的一部分)



## JVM 结构

## jvm 调优

## 什么时候会发生 GC

## 有哪些 GC 方式

## 服务器 oom 了怎么解决

##  G1 回收器和 CMS 区别

## G1 垃圾回收器有什么参数需要配置吗

## 比如 try catch 在 jvm 怎么实现的，

## GC算法：新生代、老年代